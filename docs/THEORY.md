# HRS-f Theoretical Foundation

## Overview

HRS-f (Harmonic Rayleigh Scattering - field) is a computational framework for simulating nonlinear optical responses from populations of oriented dipoles. The code implements the full tensor formalism for hyperpolarizability-mediated second harmonic generation (SHG) and related nonlinear optical phenomena.

## Theoretical Framework

### 1. Hyperpolarizability Tensor

The nonlinear optical response of each dipole is characterized by the hyperpolarizability tensor β_{ijk}:

```
P_i^(2ω) = β_{ijk} E_j^(ω) E_k^(ω)
```

Where:
- P_i^(2ω) is the i-th component of the second-harmonic polarization
- E_j^(ω), E_k^(ω) are the j-th and k-th components of the fundamental field
- β_{ijk} is the second-order hyperpolarizability tensor

### 2. Coordinate Systems and Transformations

#### Molecular Frame
Each dipole has its own molecular coordinate system defined by Euler angles (ψ, θ, φ). The transformation from molecular frame to laboratory frame is given by:

```
β_{ijk}^{lab} = Σ_{α,β,γ} R_{iα} R_{jβ} R_{kγ} β_{αβγ}^{mol}
```

Where R is the rotation matrix constructed from Euler angles.

#### Laboratory Frame
The laboratory frame is where field propagation and detection occur. The code implements:
- Field propagation along Z-axis
- Detection at angles (θ_u, φ_v) relative to the propagation direction
- Polarization analysis in the detection plane

### 3. Field Propagation and Phase Matching

#### Fundamental Field
The fundamental field at position r is:

```
E^(ω)(r) = E_0^(ω) exp(ik^(ω) · r)
```

Where k^(ω) = (2πn^(ω))/λ is the wave vector in medium with refractive index n^(ω).

#### Second Harmonic Field
The second harmonic field generated by dipole i is:

```
E^(2ω)(R) = (k^(2ω))² exp(ik^(2ω)R) / (4πε₀R) × 
           [n̂ × (n̂ × P_i^(2ω))] exp(-ik^(2ω) · r_i)
```

Where:
- R is the distance to the observation point
- n̂ is the unit vector from dipole to observer
- r_i is the position of dipole i

### 4. Multipole Contributions

The code implements several orders of multipole expansion:

#### Electric Dipole-Electric Dipole (EEE)
The standard second-order nonlinear optical response:
```
P_i^{EEE} = β_{ijk}^{EEE} E_j^(ω) E_k^(ω)
```

#### Electric Dipole-Magnetic Dipole (EME)
Includes magnetic dipole contributions:
```
P_i^{EME} = β_{ijk}^{EME} E_j^(ω) B_k^(ω)
```

#### Magnetic Dipole-Electric Dipole (MEE)
Magnetic dipole-electric dipole coupling:
```
M_i^{MEE} = β_{ijk}^{MEE} B_j^(ω) E_k^(ω)
```

#### Electric Quadrupole-Electric Dipole (QEE)
Electric quadrupole contributions with spatial derivatives:
```
P_i^{QEE} = β_{ijkl}^{QEE} ∇_l E_j^(ω) E_k^(ω)
```

### 5. Statistical Averaging

#### Orientational Averaging
For randomly oriented dipoles, the code performs Monte Carlo averaging over orientational distributions:

```
⟨I⟩ = (1/N_frames) Σ_{frame} I[{Ω_i}]
```

Where {Ω_i} represents the set of orientations for all dipoles in a given frame.

#### Positional Averaging
For systems with positional disorder, a structure can be defined and all dipoles from the same **Population** are reoriented coherently.

### 6. Detection and Polarization Analysis

#### Polarization Components
The detected intensity is decomposed into polarization components:

```
I_V = |E_x^{det}|²
I_H = |E_y^{det} cos(θ_u) + E_z^{det} sin(θ_u)|²
```

Where θ_u is the collection angle.

#### Angular Patterns
The code computes angular-dependent intensities I(γ) where γ is the angle of the fundamental field polarization.

## Implementation Details

### 1. Numerical Methods

#### Vector Operations
The code implements vectorized operations for:
- Cross products: `VV_Cross_Product`
- Scalar products: `VV_Scal_Prod`
- Dyadic products: `VV_Dyadic_Prod`

#### Tensor Operations
Tensor contractions are implemented in `TM_DotProduct` for hyperpolarizability calculations.

### 2. Performance Optimizations

#### Memory Management
- Pre-allocation of field arrays
- Efficient tensor storage
- Minimized dynamic allocation in inner loops

#### Parallelization
OpenMP parallelization over:
- Angular sampling points
- Independent dipole calculations

### 3. Validation Methods

#### Analytical Benchmarks
- Single dipole Rayleigh scattering patterns
- Symmetry properties of dipole arrays
- Conservation laws and sum rules

#### Numerical Convergence
- Frame number convergence
- Angular resolution convergence
- Spatial discretization effects

## Physical Interpretations

### 1. Coherence Effects
The code captures both:
- Coherent addition of dipole contributions (constructive/destructive interference)
- Incoherent averaging over random orientations

### 2. Near-field vs Far-field
The implementation includes:
- Far-field radiation patterns (default)
- Near-field corrections via retardation terms
- Transition regime behavior

### 3. Symmetry Breaking
The code can model:
- Chiral systems (helical arrangements)
- Oriented systems (aligned dipoles)
- Disordered systems (random orientations)

## References

1. Boyd, R.W. "Nonlinear Optics" (Academic Press)
2. Shen, Y.R. "The Principles of Nonlinear Optics" (Wiley)
3. Butcher, P.N. & Cotter, D. "The Elements of Nonlinear Optics" (Cambridge)
4. Jackson, J.D. "Classical Electrodynamics" (Wiley)

## Notation Summary

| Symbol | Description | Units |
|--------|-------------|-------|
| β_{ijk} | Hyperpolarizability tensor | m⁴/V |
| E^(ω) | Fundamental electric field | V/m |
| P^(2ω) | Second harmonic polarization | C/m² |
| k | Wave vector | m⁻¹ |
| n | Refractive index | dimensionless |
| λ | Wavelength | m |
| Ω | Solid angle | sr |
| θ, φ | Spherical coordinates | rad |
| ψ, θ, φ | Euler angles | rad |


